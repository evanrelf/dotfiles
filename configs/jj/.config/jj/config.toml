#:schema https://docs.jj-vcs.dev/latest/config-schema.json

# Shorter
aliases.d = ['diff']
aliases.dup = ['duplicate']
aliases.mut = ['--ignore-immutable']
aliases.par = ['parallelize']
aliases.s = ['status']

# Log
aliases.l = ['log', '-r', 'evan_log() | ancestors(present(@), 10)']
aliases.ll = ['log', '-r', 'evan_log() | ancestors(present(@))']
aliases.pr = ['log', '-r', 'pr()']

# Squash
aliases.give = ['squash', '--use-destination-message', '--into']
aliases.take = ['squash', '--use-destination-message', '--from']

# Bookmark
aliases.here = ['bookmark', 'move', '--to', '@-']
aliases.tug = ['bookmark', 'move', '--from', 'bookmark()', '--to', '@-']

# Git
aliases.blame = ['file', 'annotate']
aliases.clone = ['git', 'clone']
aliases.fetch = ['git', 'fetch']
aliases.init = ['git', 'init']
aliases.merge = ['util', 'exec', '--', 'bash', '-c', '''
if [ "$#" -gt 1 ]; then
  echo "usage: jj merge [REVSET]" >&2
  exit 1
fi
revset=${1:-"trunk()"}
jj new @- "exactly($revset, 1)" --message "Merge \`$revset\`" && jj new
''', '']
aliases.push = ['git', 'push']
aliases.remote = ['git', 'remote']

aliases.watch = ['util', 'exec', '--', 'jj-watch']

user.name = 'Evan Relf'
user.email = 'evan@evanrelf.com'
ui.default-command = ['log', '-r', 'evan_log()']
ui.diff-formatter = ':git'
ui.diff-editor = ':builtin'
ui.merge-editor = 'mergiraf'
ui.pager = 'delta'
git.colocate = true
git.private-commits = 'private()'
git.write-change-id-header = true
signing.behavior = 'own'
signing.backend = 'ssh'
signing.key = '~/.ssh/jj.pub'

revsets.log = 'evan_log()'
revsets.short-prefixes = 'evan_log()'
revsets.log-graph-prioritize = 'coalesce(megamerge(), present(@))'
revset-aliases.'default_log()' = 'present(@) | ancestors(immutable_heads().., 2) | present(trunk())'
revset-aliases.'evan_log()' = 'present(@) | (ancestors(immutable_heads().., 2) & mine()) | present(trunk()) | bookmarks()'
revset-aliases.'megamerge()' = 'exactly(coalesce(@ & merges(), heads(reachable(@, mutable()) & merges()), root()), 1) ~ root()'
revset-aliases.'M' = 'megamerge()'
revset-aliases.'private()' = '(subject(glob:"private:*") & mine()) | descendants(megamerge()) | descendants(wip())'
revset-aliases.'wip()' = 'subject(glob:"wip:*") & mine()'
# Nearest bookmark.
revset-aliases.'bookmark()' = 'heads(ancestors(@) & bookmarks())'
# Commits you'd see on GitHub pull requests.
revset-aliases.'pr()' = 'ancestors(bookmark()) ~ ancestors(trunk())'
revset-aliases.'pr(x)' = 'ancestors(x) ~ ancestors(trunk())'
revset-aliases.'prs()' = 'pr(bookmarks())'

colors.'evan_working_copy' = { bold = true }
templates.git_push_bookmark = '"evanrelf/push-" ++ change_id.short()'
templates.log = 'evan_log'
templates.log_node = 'evan_log_node'
template-aliases.'format_short_id(id)' = 'id.shortest(6)'
template-aliases.evan_log_node = '''
coalesce(
  if(!self, label("elided", "┆")),
  label(
    separate(" ",
      if(current_working_copy, "evan_working_copy"),
      if(conflict, "conflicted"),
    ),
    coalesce(
      if(current_working_copy, "@"),
      if(self.contained_in("megamerge()"), "M"),
      if(immutable, "·"),
      "○",
    )
  )
)
'''
template-aliases.evan_log = '''
if(root,
  format_root_commit(self),
  label(if(current_working_copy, "evan_working_copy"),
    concat(
      separate(" ",
        format_short_change_id_with_hidden_and_divergent_info(self),
        format_short_commit_id(commit_id),
        pad_start(3, format_log_timestamp(commit_timestamp(self))),
        evan_log_description,
        bookmarks,
        tags,
        working_copies,
      ) ++ "\n",
    ),
  ),
) ++ evan_log_status
'''
template-aliases.'evan_log_description' = '''
  label(
    separate(" ",
      if(!description || self.contained_in("wip()"), "description placeholder"),
      if(empty, "empty"),
    ),
    separate(" ",
      if(conflict, label("conflict", "conflict")),
      stringify(if(description,
        description.first_line(),
        description_placeholder,
      )),
      surround("(", ")", separate(", ",
        if(empty, "empty"),
        if(self.contained_in("megamerge()"), "megamerge"),
      ))
    ),
  )
'''
template-aliases.'evan_log_status' = '''
if(!empty && (current_working_copy || !description || self.contained_in("wip()")),
  diff.summary() ++ "\n"
)
'''
template-aliases.'ts(timestamp)' = 'timestamp.ago().remove_suffix(" ago").remove_suffix("s")'
template-aliases.'format_log_timestamp(t)' = '''
if(
  ts(t).ends_with("second"),
  ts(t).remove_suffix(" second") ++ label("timestamp", "s"),
if(
  ts(t).ends_with("minute"),
  ts(t).remove_suffix(" minute") ++ label("timestamp", "m"),
if(
  ts(t).ends_with("hour"),
  ts(t).remove_suffix(" hour") ++ label("timestamp", "h"),
if(
  ts(t).ends_with("day"),
  ts(t).remove_suffix(" day") ++ label("timestamp", "d"),
if(
  ts(t).ends_with("week"),
  ts(t).remove_suffix(" week") ++ label("timestamp", "wk"),
if(
  ts(t).ends_with("month"),
  ts(t).remove_suffix(" month") ++ label("timestamp", "mo"),
if(
  ts(t).ends_with("year"),
  ts(t).remove_suffix(" year") ++ label("timestamp", "yr"),
ts(t),
)))))))
'''

[[--scope]]
--when.repositories = ['~/Code/MercuryTechnologies/']
[--scope.user]
email = 'evanr@mercury.com'
[--scope.fsmonitor]
backend = 'watchman'
