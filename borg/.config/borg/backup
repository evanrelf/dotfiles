#!/bin/sh

set -euo pipefail

# Requires that the following environment variables are set:
# - BORG_REPO="username@host:borg/repo/path"
# - BORG_PASSPHRASE="hunter2"
# - BORG_REMOTE_PATH="/path/to/remote/borg"

if [ -z "$BORG_REPO" ] || [ -z "$BORG_PASSPHRASE" ] || [ -z "$BORG_REMOTE_PATH" ]; then
  echo "Environment variables are not configured correctly" >&2
  exit 1
fi

notify-send "Borg" "Backup starting"
/usr/bin/borg \
  --verbose \
  create \
  --stats \
  --exclude-from "/home/evanrelf/.config/borg/exclude" \
  --compression zstd,10 \
  ::"$(hostname)-$(date "+%Y-%m-%d_%H-%M")" \
  "/home/evanrelf" \
  || (notify-send --urgency=critical "Borg" "Backup failed to complete"; exit 1)
notify-send "Borg" "Backup finished successfully"

notify-send "Borg" "Pruning backups"
/usr/bin/borg \
  --verbose \
  prune \
  --stats \
  --save-space \
  --keep-hourly=24 \
  --keep-daily=30 \
  --keep-weekly=8 \
  --keep-monthly=12 \
  || (notify-send --urgency=critical "Borg" "Pruning failed to complete"; exit 1)
notify-send "Borg" "Pruning finished successfully"
